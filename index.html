<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mexico Trip Map — Photo‑Rich (Leaflet + Google Sheet)</title>
  <!-- Leaflet + plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <!-- GLightbox (gallery) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
  <!-- App styles -->
  <style>
    :root{
      --bg:#f8fafc; /* light */
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#0ea5e9;
      --border:#e2e8f0;
      --chip:#e7f5ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;color:var(--text);background:var(--bg)}
    #app{display:grid;grid-template-columns:360px 1fr;grid-template-rows:100vh}
    @media (max-width:960px){#app{grid-template-columns:1fr;grid-template-rows:auto 80vh}}

    /* Sidebar */
    .sidebar{background:var(--panel);border-right:1px solid var(--border);padding:14px;overflow:auto}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .brand h1{font-size:18px;margin:0}
    .small{color:var(--muted);font-size:12px}
    .controls{display:grid;gap:10px;margin:10px 0}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="search"],select,button,.date-row input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px}
    .row{display:flex;gap:8px}
    .row>*{flex:1}
    .btn{cursor:pointer;background:var(--primary);color:#fff;border:none}
    .btn.secondary{background:#e2e8f0;color:#0f172a}
    .counts{font-size:12px;color:var(--muted);margin:6px 0}
    .list{border-top:1px solid var(--border);margin-top:10px}
    .card{padding:10px 6px;border-bottom:1px solid var(--border)}
    .card h3{margin:0 0 6px 0;font-size:14px}
    .meta{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:6px;margin-top:6px}

    /* Map */
    #map{width:100%;height:100%}

    /* Marker (color dot) */
    .pin{display:flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;color:#fff;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.25);border:2px solid #fff}
    .pin.big{transform:scale(1.1)}

    /* Popup */
    .popup{min-width:260px}
    .popup h3{margin:0 0 6px 0;font-size:16px}
    .chipsline{display:flex;gap:6px;margin:6px 0}
    .thumbs{display:flex;gap:6px;flex-wrap:wrap}
    .thumbs a{display:block;width:84px;height:60px;background:#f1f5f9;border-radius:8px;overflow:hidden}
    .thumbs img{width:100%;height:100%;object-fit:cover;display:block}
    .pop-actions{display:flex;gap:8px;margin-top:8px}
    .pop-actions a{flex:1;text-align:center;display:inline-block;padding:8px 10px;border-radius:10px;text-decoration:none;background:#e2e8f0;color:#0f172a;font-size:13px}
    .pop-actions a.primary{background:var(--primary);color:#fff}

    /* Loader */
    .loader{padding:10px;font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
<div id="app">
  <aside class="sidebar">
    <div class="brand">
      <h1>Mexico Trip Map</h1>
    </div>
    <div class="small">Photo‑rich pins from a Google Sheet. Edit the sheet → refresh the page.</div>

    <div class="controls">
      <div class="field">
        <label>Search</label>
        <input id="q" type="search" placeholder="Find places (title, city, notes)…"/>
      </div>
      <div class="row">
        <div class="field">
          <label>Phase</label>
          <select id="phase" multiple size="4"></select>
        </div>
        <div class="field">
          <label>Category</label>
          <select id="category" multiple size="6"></select>
        </div>
      </div>
      <div class="row date-row">
        <div class="field">
          <label>From</label>
          <input id="from" type="date" />
        </div>
        <div class="field">
          <label>To</label>
          <input id="to" type="date" />
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Status</label>
          <select id="status" multiple size="3"></select>
        </div>
        <div class="field">
          <label>Actions</label>
          <div class="row">
            <button id="clear" class="btn secondary">Clear filters</button>
            <button id="export" class="btn">Export</button>
          </div>
        </div>
      </div>
      <div class="counts" id="counts">Loading…</div>
    </div>

    <div class="list" id="list"></div>
  </aside>
  <main>
    <div id="map"></div>
  </main>
</div>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
<script src="https://unpkg.com/tokml@0.4.0/tokml.js"></script>

<script>
// =====================
//  CONFIG — EDIT ME
// =====================
const CONFIG = {
  SHEET_ID: '1tIfwY7YqOXIZ-rSFuXL0KedjKkfmo9S0fp1NEo70TVE', // <- your Sheet ID
  SHEET_TAB: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSFLpA5UrQ3lfiR8fHaxRWOFnQzrIt7P1rg8ancYvnxvC8OxYsZJWhF8-i5zp-eGM6hcU7VhTi1AFcN/pub?gid=0&single=true&output=csv', // <- tab name
  FALLBACK_CENTER: [19.4326, -99.1332], // Mexico City
  FALLBACK_ZOOM: 5
};

const CATEGORY_COLORS = {
  ruin:'#8b5cf6', museum:'#10b981', market:'#84cc16', food:'#ef4444', bar_cafe:'#f59e0b', neighborhood:'#3b82f6',
  nature:'#22c55e', cenote:'#06b6d4', transit:'#9ca3af', stay:'#0ea5e9', tour:'#d946ef', event:'#f97316'
};

// Tiny utility
const $ = sel => document.querySelector(sel);
const h = (tag, attrs={}, children=[]) => { const el=document.createElement(tag); for(const k in attrs){
  if(k==='class') el.className=attrs[k];
  else if(k==='html') el.innerHTML=attrs[k];
  else el.setAttribute(k, attrs[k]);
} (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=> el.appendChild(typeof c==='string'?document.createTextNode(c):c)); return el };

function csvURL(){
  const u = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(CONFIG.SHEET_TAB)}&_=${Date.now()}`;
  return u;
}

// Global state
let RAW_ROWS = [];
let FEATURES = []; // GeoJSON-like features used for map + list
let MAP, CLUSTER, LIGHTBOX, FUSE;

const loader = h('div',{class:'loader',id:'loader',html:'Fetching itinerary…'});
$('#list').appendChild(loader);

init();

async function init(){
  // Map
  MAP = L.map('map', {zoomControl:true}).setView(CONFIG.FALLBACK_CENTER, CONFIG.FALLBACK_ZOOM);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(MAP);
  CLUSTER = L.markerClusterGroup();
  MAP.addLayer(CLUSTER);

  // Lightbox
  LIGHTBOX = GLightbox({selector:'.glightbox'});

  // Fetch data
  try {
    await fetchCSV();
  } catch(e){
    console.warn('CSV load failed, using fallback', e);
    RAW_ROWS = fallbackRows();
  }

  FEATURES = rowsToFeatures(RAW_ROWS);
  buildFilters(FEATURES);
  buildSearch(FEATURES);
  render(FEATURES);

  // if deep link ?id=xyz focus it
  const params = new URLSearchParams(location.search);
  const want = params.get('id');
  if (want){
    const f = FEATURES.find(x=> (x.properties.id||'').toLowerCase()===want.toLowerCase());
    if (f){
      const m = f._marker; if(m){ MAP.setView(m.getLatLng(), 13); m.fire('click'); }
    }
  }
}

function fetchCSV(){
  return new Promise((resolve,reject)=>{
    Papa.parse(csvURL(), {
      download:true, header:true, skipEmptyLines:true,
      complete: res => { RAW_ROWS = res.data; resolve(); },
      error: err => reject(err)
    });
  });
}

function rowsToFeatures(rows){
  const feats = [];
  for (const r of rows){
    const lat = parseFloat(r.lat), lng = parseFloat(r.lng);
    if (Number.isNaN(lat) || Number.isNaN(lng)) continue; // require coords
    const cat = (r.category||'').trim();
    const color = CATEGORY_COLORS[cat] || '#3b82f6';
    const pri = (r.priority||'').toString().trim();
    const isBig = (pri==='1' || pri==='2');
    const imgs = (r.image_urls||'').split(/\s*,\s*/).filter(Boolean);
    const credits = (r.image_credits||'').split(/\s*,\s*/).filter(Boolean);

    const f = {
      type:'Feature',
      geometry:{type:'Point', coordinates:[lng,lat]},
      properties:{
        id: (r.id||'').trim(),
        date: (r.date||'').trim(),
        phase: (r.phase||'').trim(),
        city: (r.city||'').trim(),
        title: (r.title||'').trim(),
        category: cat,
        short_desc: (r.short_desc||'').trim(),
        tips: (r.tips||'').trim(),
        directions_url: (r.directions_url||'').trim(),
        priority: pri,
        status: (r.status||'planned').trim() || 'planned',
        images: imgs,
        credits: credits
      }
    };

    // marker
    const icon = L.divIcon({className:'', html:`<div class="pin ${isBig?'big':''}" style="background:${color}" title="${f.properties.title}">•</div>`});
    const marker = L.marker([lat,lng], {icon});
    marker.bindPopup(buildPopupHTML(f), {className:'popup'});
    CLUSTER.addLayer(marker);
    f._marker = marker;

    feats.push(f);
  }
  // Fit bounds
  setTimeout(()=>{
    if (feats.length){
      const group = L.featureGroup(feats.map(f=>f._marker));
      MAP.fitBounds(group.getBounds().pad(0.15));
    }
  }, 0);
  return feats;
}

function buildPopupHTML(f){
  const p = f.properties;
  const chips = [p.phase, p.category, p.status].filter(Boolean).map(x=>`<span class="chip">${escapeHtml(x)}</span>`).join('');
  const imgs = (p.images||[]).map((url, idx)=>{
    const cap = (p.credits && p.credits[idx]) ? ` — ${escapeHtml(p.credits[idx])}` : '';
    const gid = `g${p.id||p.title}`;
    return `<a href="${url}" class="glightbox" data-gallery="${gid}" data-title="${escapeHtml(p.title)}${cap}"><img loading="lazy" src="${url}" alt="${escapeHtml(p.title)}"></a>`
  }).join('');

  const dirBtn = p.directions_url ? `<a class="primary" target="_blank" rel="noopener" href="${p.directions_url}">Directions</a>` : '';
  const linkBtn = `<a href="${location.pathname}?id=${encodeURIComponent((p.id||'').toLowerCase())}" target="_self">Link</a>`;

  const html = `
    <div>
      <h3>${escapeHtml(p.title||'Untitled')}</h3>
      <div class="chipsline">${chips}</div>
      ${p.date?`<div class="meta">${escapeHtml(p.date)} — ${escapeHtml(p.city||'')}</div>`:''}
      ${p.short_desc?`<div class="meta">${escapeHtml(p.short_desc)}</div>`:''}
      ${p.tips?`<div class="meta"><em>${escapeHtml(p.tips)}</em></div>`:''}
      ${p.images && p.images.length?`<div class="thumbs">${imgs}</div>`:''}
      <div class="pop-actions">${dirBtn}${linkBtn}</div>
    </div>
  `;
  return html;
}

function buildFilters(feats){
  const phases = uniq(feats.map(f=>f.properties.phase).filter(Boolean)).sort();
  const cats = uniq(feats.map(f=>f.properties.category).filter(Boolean)).sort();
  const statuses = uniq(feats.map(f=>f.properties.status).filter(Boolean)).sort();

  fillMultiSelect($('#phase'), phases);
  fillMultiSelect($('#category'), cats);
  fillMultiSelect($('#status'), statuses);

  $('#clear').addEventListener('click', ()=>{
    $('#q').value='';
    [...$('#phase').options].forEach(o=>o.selected=false);
    [...$('#category').options].forEach(o=>o.selected=false);
    [...$('#status').options].forEach(o=>o.selected=false);
    $('#from').value='';$('#to').value='';
    render(FEATURES);
  });

  $('#export').addEventListener('click', ()=> doExport());
  $('#q').addEventListener('input', debounce(()=> render(FEATURES), 200));
  $('#phase').addEventListener('change', ()=> render(FEATURES));
  $('#category').addEventListener('change', ()=> render(FEATURES));
  $('#status').addEventListener('change', ()=> render(FEATURES));
  $('#from').addEventListener('change', ()=> render(FEATURES));
  $('#to').addEventListener('change', ()=> render(FEATURES));
}

function buildSearch(feats){
  FUSE = new Fuse(feats.map(f=>({
    id: f.properties.id,
    title: f.properties.title,
    city: f.properties.city,
    short_desc: f.properties.short_desc
  })), {keys:['title','city','short_desc'], threshold:0.4});
}

function currentFilters(){
  const getSel = sel => [...$(sel).selectedOptions].map(o=>o.value);
  return {
    q: ($('#q').value||'').trim(),
    phases: getSel('#phase'),
    cats: getSel('#category'),
    stats: getSel('#status'),
    from: $('#from').value? new Date($('#from').value): null,
    to: $('#to').value? new Date($('#to').value): null
  };
}

function render(all){
  const F = currentFilters();
  // filter
  let arr = all.slice();
  if (F.q){
    const res = FUSE.search(F.q).map(x=>x.item.id);
    arr = arr.filter(f=> res.includes(f.properties.id));
  }
  if (F.phases.length) arr = arr.filter(f=> F.phases.includes(f.properties.phase));
  if (F.cats.length) arr = arr.filter(f=> F.cats.includes(f.properties.category));
  if (F.stats.length) arr = arr.filter(f=> F.stats.includes(f.properties.status));
  if (F.from) arr = arr.filter(f=> f.properties.date && new Date(f.properties.date)>=F.from);
  if (F.to) arr = arr.filter(f=> f.properties.date && new Date(f.properties.date)<=F.to);

  // map markers
  CLUSTER.clearLayers();
  arr.forEach(f=> f._marker && CLUSTER.addLayer(f._marker));

  // list
  const list = $('#list');
  list.innerHTML='';
  if (!arr.length){ list.appendChild(h('div',{class:'loader',html:'No results. Adjust filters.'})); }
  arr.sort((a,b)=> (a.properties.date||'') < (b.properties.date||'') ? -1: 1);
  arr.forEach(f=> list.appendChild(renderCard(f)) );

  $('#counts').textContent = `${arr.length} result${arr.length===1?'':'s'} (of ${all.length})`;
}

function renderCard(f){
  const p = f.properties;
  const chips = [p.phase,p.category,p.status].filter(Boolean).map(x=>h('span',{class:'chip'},x));
  const card = h('div',{class:'card'});
  const title = h('h3',{}, p.title || 'Untitled');
  const meta = h('div',{class:'meta'}, `${p.date? p.date+ ' — ':''}${p.city||''}`);
  const actions = h('div',{class:'actions'});
  const btnFocus = h('button',{class:'btn secondary'},'Focus');
  btnFocus.addEventListener('click', ()=>{ const m=f._marker; if(m){ MAP.setView(m.getLatLng(), 14); m.fire('click'); }});
  const btnLink = h('button',{class:'btn secondary'},'Copy link');
  btnLink.addEventListener('click', ()=>{
    const url = location.origin + location.pathname + '?id=' + encodeURIComponent((p.id||'').toLowerCase());
    navigator.clipboard.writeText(url); btnLink.textContent='Copied'; setTimeout(()=>btnLink.textContent='Copy link',1200);
  });
  actions.append(btnFocus, btnLink);

  card.append(title, meta, h('div',{class:'chips'},chips), actions);
  return card;
}

function doExport(){
  const F = currentFilters();
  let arr = FEATURES.slice();
  if (F.phases.length) arr = arr.filter(f=> F.phases.includes(f.properties.phase));
  if (F.cats.length) arr = arr.filter(f=> F.cats.includes(f.properties.category));
  if (F.stats.length) arr = arr.filter(f=> F.stats.includes(f.properties.status));
  if (F.from) arr = arr.filter(f=> f.properties.date && new Date(f.properties.date)>=F.from);
  if (F.to) arr = arr.filter(f=> f.properties.date && new Date(f.properties.date)<=F.to);

  const geojson = {type:'FeatureCollection', features: arr.map(f=>({type:'Feature', geometry:f.geometry, properties:f.properties}))};
  const kml = tokml(geojson, {name: 'title', description: 'short_desc'});

  // Two downloads
  download('trip.geojson', JSON.stringify(geojson,null,2));
  download('trip.kml', kml);
}

function download(filename, text){
  const a = document.createElement('a');
  a.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  a.setAttribute('download', filename);
  a.style.display='none';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

function fillMultiSelect(sel, values){
  sel.innerHTML='';
  values.forEach(v=> sel.appendChild(h('option',{value:v},v)));
}

function uniq(arr){ return [...new Set(arr)]; }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }

function fallbackRows(){
  // Minimal sample so the app still loads if CSV is unavailable
  return [
    {id:'sample-teotihuacan',date:'2025-11-14',phase:'Mexico City',city:'Mexico City',title:'Teotihuacán Archaeological Zone',category:'ruin',lat:'19.6925',lng:'-98.8433',short_desc:'Sample fallback pin. Replace with your sheet.',tips:'Go early.',image_urls:'https://upload.wikimedia.org/wikipedia/commons/e/e9/Teotihuacan_Piramide_del_Sol.jpg',image_credits:'Diego Delso / Wikimedia',directions_url:'',priority:'2',status:'planned'}
  ];
}
</script>
</body>
</html>
